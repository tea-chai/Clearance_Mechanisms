
import numpy as np

import matplotlib.pyplot as plt_demand
import matplotlib.pyplot as plt_state
import matplotlib.pyplot as plt_price
import matplotlib.pyplot as plt

import pandas as pd

import random
import sys	

Total_TIME = 743;

Max_BATTERY = 20;

def main(numUsers, ratProsumers, Battery_INIT):  

	#print("*****", numUsers, ratProsumers, "***")
	percentageProsumers = ratProsumers;
	percentageBuyers = 100 - ratProsumers;

	numProsumers = int(numUsers * percentageProsumers / 100);
	numBuyers = int (numUsers * percentageBuyers / 100);
	
	prosumer_seller_toGrid_Addition = 0 ;
	BuyersTotalDemand = 0;
	BuyerFromP2P = 0;
 
	isSeller_Total = 0;
	numProsumers_Total = 0;

	Overall_Total_Supplies = 0;
	prosumer_seller_ToP2P = 0 ;

	prosumer_seller_consumption = 0;

	prosumer_consumer_from_Self = 0;
	prosumer_consumer_from_Supp = 0;

	File_Path_Generated  = "./PV_Generated_4KWp_January.csv"
	File_Path_Seller_Consumed= "./prosumer_January.csv"
	File_Path_Buyer_Consumed= "./buyer_January.csv"
	
	df_gen = pd.read_csv(File_Path_Generated,sep = ',',low_memory=False)		
	df_gen = df_gen.iloc[: , 2:]
	
	df_prosumer_con = pd.read_csv(File_Path_Seller_Consumed,sep = ',',low_memory=False)
	df_prosumer_con = df_prosumer_con.iloc[: , 2:]

	df_buyer_con = pd.read_csv(File_Path_Buyer_Consumed,sep = ',',low_memory=False)
	df_buyer_con = df_buyer_con.iloc[: , 2:]
	
	#battInit = 0	
	#battery_charged = [battInit for i in range(numProsumers)]

	battery_charged = Battery_INIT

	#print('battery_chargedWWW', battery_charged)

	#quit()


	
	for time in range(0, Total_TIME):
	

		#print("***** TIME ",time,'*****' )

		#print('battery_charged',battery_charged)
		V_gen = df_gen.iloc[time].to_numpy()[0:numProsumers]
		V_prosumer_con = df_prosumer_con.iloc[time].to_numpy()[0:numProsumers]
		V_buyer_con = df_buyer_con.iloc[time].to_numpy()[0:numBuyers]
		
		'''		
		print(V_prosumer_con[0:15])
		print(V_buyer_con[0:10])
		print(V_gen[0:10])		
		'''
		#print('V_gen',V_gen)
		#print('V_prosumer_con',V_prosumer_con)
		#print('V_buyer_con',V_buyer_con)
		self_power = [V_gen[i] + battery_charged[i] for i in range(numProsumers)]
		energyDifference = [self_power[i] - V_prosumer_con[i] for i in range(numProsumers)]

		Prosumer_isSellerArr = [diff > 0 for diff in energyDifference]	

		#print('Prosumer_isSellerArr',Prosumer_isSellerArr)
		isSeller_Total +=sum(Prosumer_isSellerArr);		
		numProsumers_Total += numProsumers;
	
		Supplies= []

		for i in range(numProsumers):
			if Prosumer_isSellerArr[i]: # Seller
				
				Supplies.append(energyDifference[i])
				prosumer_seller_consumption += V_prosumer_con[i] 

			else: # consumer
				Supplies.append(0)
				prosumer_consumer_from_Self += self_power[i] 
				prosumer_consumer_from_Supp += V_prosumer_con[i] - self_power[i] 
	
	
		TotalSupply = sum(Supplies);
		Overall_Total_Supplies += TotalSupply;

		TotalDemand = sum(V_buyer_con);
		BuyersTotalDemand += TotalDemand

		if(TotalSupply>TotalDemand):
			Supplies_to_P2P = [TotalDemand * amount/ TotalSupply for amount in Supplies]	
		else:
			Supplies_to_P2P = Supplies;

		#print('Supplies_to_P2P',Supplies_to_P2P)

		if((Supplies_to_P2P)):
			prosumer_seller_ToP2P += sum(Supplies_to_P2P)		

		BuyerFromP2P += TotalDemand if TotalDemand <= TotalSupply else TotalSupply
		
		for i in range(numProsumers):
			if Prosumer_isSellerArr[i]: # Seller
				
				potential_charge = self_power[i] - V_prosumer_con [i]- Supplies_to_P2P[i]
				
					
				if(potential_charge<Max_BATTERY):
					
					battery_charged[i] = potential_charge;
				else:
					#print('ALERT!')
					#quit('ALERT')
					battery_charged[i]= Max_BATTERY;
					prosumer_seller_toGrid_Addition += potential_charge - Max_BATTERY;
					
			else: # consumer
				#print('here')
				battery_charged[i]=0

		#if(time==Total_TIME):
			#print('battery_charged',battery_charged)
			
	 
	BuyerFromSupp = BuyersTotalDemand  - BuyerFromP2P
	seller_ratio = (isSeller_Total)/numProsumers_Total *100
	prosumer_seller_toGrid = Overall_Total_Supplies - prosumer_seller_ToP2P + prosumer_seller_toGrid_Addition
		

	#print(BuyerFromP2P)
	#print(BuyerFromSupp)
	#print(seller_ratio)
	#print(prosumer_seller_ToP2P)	
	#print(prosumer_seller_toGrid_Addition)
	#print(prosumer_seller_consumption)
	#print(prosumer_consumer_from_Self);
	print(prosumer_consumer_from_Supp);
	

	#print('prosumer_seller_toGrid',prosumer_seller_toGrid)

	#print('battery_charged',battery_charged)
if __name__ == '__main__':


	Battery_INIT = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
	main(40,25,Battery_INIT)
	Battery_INIT = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
	main(80,25,Battery_INIT)
	Battery_INIT = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] 
	main(120,25,Battery_INIT)
	Battery_INIT = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
	main(160,25,Battery_INIT)
	Battery_INIT = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
	main(200,25,Battery_INIT)

	Battery_INIT = [4.927772125299045, 5.439610364789945, 2.523840950625363, 2.7160041766850105, 6.855784437843501, 1.6540048378665506, 3.3291379249680038, 5.624925736841868, 0, 1.7963470575052838, 5.08573763522722, 4.52569337609062, 2.6418703228532054, 4.713236801643191, 4.4564906430055755, 5.334401566000194, 2.8830877103018118, 3.0557692066008273, 6.261959076967272, 6.479129119856555]
	main(40,50,Battery_INIT)
	Battery_INIT = [2.0085640034435586, 2.1807707597663377, 0.857098318142649, 0.9478738929970426, 2.870596321081476, 0.5023175707760273, 1.1331085525143874, 2.149185516315064, 0, 0, 1.9894316233329135, 1.7327146181933037, 0.9427455221225187, 1.779999895996385, 1.6722910002051572, 2.0800317854931, 0.9327175030179883, 0.6202737873924747, 2.6353017927697486, 2.68935688456153, 0, 0, 0, 3.2269815960539656, 1.525305438995246, 2.823662526796916, 0.3663667488051905, 1.816360913940147, 2.060356654395819, 0, 2.7477460936281175, 0, 0, 2.605269528770394, 0, 0, 2.4607282706183793, 0, 2.864825456910783, 1.0651156289721477] 
	main(80,50,Battery_INIT)
	Battery_INIT = [1.657383252165205, 1.7942746327615768, 0.7327528174126127, 0.7690360477731535, 2.3871801883320622, 0.4140521912800814, 0.9113700974999676, 1.7598536026427838, 0, 0, 1.6341201782985937, 1.4243413591368195, 0.7994560251885733, 1.4596586458015977, 1.378267592625284, 1.7188678651839884, 0.7700279309001044, 0.3758455741819921, 2.19142515550041, 2.2337641756018587, 0, 0, 0, 2.6947035930842187, 1.239135864105072, 2.349968749499346, 0.29738945573379344, 1.4966750990537907, 1.6808437095370115, 0, 2.283307302098479, 0, 0, 2.1654503858349745, 0, 0, 2.042879763044641, 0, 2.3899633549972426, 0.8511828570017725, 1.585953989821618, 0, 0, 0.8038935736890621, 1.3803036195188771, 1.5069660743460425, 0.04081033007865269, 0, 1.652894919319815, 1.5955126385316536, 0.41508285637317865, 1.5402132295509734, 0, 0, 0.8748275634810736, 0.8640562227492369, 2.2765767413293387, 1.2684631425310706, 0.17052517064931352, 2.261064770345982]
	main(120,50,Battery_INIT)
	Battery_INIT = [1.5755310047343016, 1.7057409353918225, 0.6962928981116646, 0.7285643281634928, 2.275780083860191, 0.3876493044789692, 0.8558844052121147, 1.6724503007562999, 0, 0, 1.5541624396032026, 1.3517158492706547, 0.7596126870232671, 1.3830433600286234, 1.3110177924234003, 1.6348987680452094, 0.7347248585039114, 0.32602435137085567, 2.088487456425463, 2.1300103069648424, 0, 0, 0, 2.5721701521324123, 1.1733036626533522, 2.2396955659241256, 0.27639737133952147, 1.4215983020190157, 1.596604074756125, 0, 2.176600750755057, 0, 0, 2.0649861526467177, 0, 0, 1.946931145667841, 0, 2.2808203016113784, 0.8043734057618327, 1.5043876808025936, 0, 0, 0.7634377724337964, 1.3129559018599384, 1.4333206777675982, 0.023387644966095963, 0, 1.5703093618555253, 1.5168181629165085, 0.36238621253214887, 1.4641095831677955, 0, 0, 0.8352986958744677, 0.8206282155212872, 2.171935842998761, 1.203019991444088, 0.14929218758991053, 2.157594418185231, 0.86449989468944, 0.38374649623188706, 0, 1.524984041734302, 0.16169715495554499, 2.5493824863058956, 1.804749415333138, 0.8373196585143493, 1.2806437205143426, 1.2628756577645215, 0, 1.3861927550699762, 0, 0, 0.8673670000596482, 0.2887261310565984, 0.8765047857431321, 0, 0, 0]
	main(160,50,Battery_INIT)
	Battery_INIT = [1.7038929629886408, 1.8415245934959494, 0.7693161098258554, 0.8002487459232316, 2.4441336204649544, 0.4437668831830085, 0.9391020989630805, 1.8104916598334764, 0, 0, 1.6850783260627322, 1.467848601379212, 0.8363399238489264, 1.5023689535490923, 1.4216765193574992, 1.7584516072269631, 0.8072902971200426, 0.4176381709457989, 2.2454886795992524, 2.2895881461040215, 0, 0, 0, 2.752430693052199, 1.2803205349855107, 2.406334421162935, 0.3252215762825825, 1.536123504734804, 1.7303405755834547, 0, 2.338573128229579, 0, 0, 2.2196143746187085, 0, 0, 2.0948829957996646, 0, 2.4441156945342204, 0.8864765462815072, 1.6356442062934746, 0, 0, 0.8416343085343757, 1.4244630219409504, 1.55569800949676, 0.07185997968467017, 0, 1.7014163490185994, 1.643986911847419, 0.4590448367171055, 1.585252194482977, 0.02208819759835112, 0, 0.9132473399351462, 0.9006168708578521, 2.326647280567464, 1.3070671222508454, 0.20450022537057272, 2.311990327128883, 0.9482387007496086, 0.43822068173857875, 0, 1.6577660110557846, 0.2014384278381686, 2.7270709253789214, 1.9474155854565494, 0.9178622019095097, 1.390710790944088, 1.3730043633768223, 0, 1.5079117439863943, 0, 0, 0.9553553398403756, 0.33786174919403555, 0.961010072471528, 0, 0, 0, 0.8463920383594296, 1.4496245414559819, 1.6935165916011625, 0, 0.7188070602578186, 0.7256476838069686, 1.645412339764208, 2.6151027445785644, 0.2594360354824894, 1.425497938282568, 1.9261417634771028, 0.3396200353502496, 2.7499669779483704, 1.1011536557646382, 1.4486770629178607, 1.6688723006560968, 0.051720879215237776, 0.8090937534788527, 0, 0.9084988478500571]
	main(200,50,Battery_INIT)

	Battery_INIT = [15.988287227989156, 16.326741855215058, 9.919457709967983, 8.963566431340865, 17.336508733086525, 5.102644783550853, 14.205068871452012, 16.150567561666684, 0, 14.685500078495968, 16.518067236985786, 15.600747887364324, 10.017436924739354, 15.555178573689467, 14.563231835279353, 16.742247720504576, 13.556600789178116, 12.126816956488872, 17.08657565125099, 17.32736082035168, 2.4840086309779115, 5.47452016871074, 0, 17.836666597802854, 13.966026883091795, 17.08972193676838, 4.105697142177621, 8.842714643760464, 16.044713659063255, 0]
	main(40,75,Battery_INIT)
	Battery_INIT =[16.384868526202204, 16.727979357342917, 11.397034759437682, 9.816195138202046, 17.75486652851582, 6.349037121680859, 16.475822776622337, 16.553901156168898, 0, 15.124725432360348, 16.926868543476335, 15.993922371222661, 11.501882221950444, 15.948925741956353, 16.298095311053395, 17.151653835071443, 15.899124077001055, 13.398718752743338, 17.49996186713685, 17.745758784371652, 3.046735560544286, 6.407895471373242, 0, 18.260098828676547, 15.66536560664214, 17.502847000491265, 5.2128847537085745, 9.494150175429404, 16.447109832500995, 0, 17.746470319150067, 8.658446037846021, 0, 17.74676588423765, 0.6392168398908593, 12.95002712291376, 16.875838077014503, 8.858340067338832, 17.687800640411766, 15.827951645343731, 16.209561945466536, 4.8925337107026, 4.611145457249162, 12.078216329405116, 15.613220003899883, 16.014093601953995, 10.339156195822, 0, 16.529189986719324, 16.49074149358487, 14.257401298796681, 16.389765714920937, 9.184741023637311, 3.512935469805682, 16.040687641088304, 12.29798814552604, 17.68408479920477, 16.501098907231718, 10.188524585361197, 17.690769841322297]
	main(80,75,Battery_INIT)
	Battery_INIT = [16.310287839273332, 16.65215306297716, 11.202360548358977, 9.679559032599457, 17.675592875812292, 6.196944811699659, 16.400067202652053, 16.47780118263611, 0, 15.032046839436108, 16.849847749654753, 15.920774626999053, 11.307461800044074, 15.875794428002015, 15.944951968222048, 17.074583832239668, 15.826635258694315, 13.191554994121267, 17.421538823219066, 17.666454094870613, 2.9633645076610926, 6.269374119568502, 0, 18.179371535162907, 15.42213392236195, 17.424445197252208, 5.082174491206648, 9.366357954661874, 16.37122080235296, 0, 17.66717349269773, 8.616475495868576, 0, 17.6675170296491, 0.5732371704517981, 12.887454200377423, 16.79986817161178, 8.815554458424275, 17.609075711821465, 15.754590248273024, 16.134466406514925, 4.799333607323357, 4.524172152545185, 11.870448115995544, 15.541910878250617, 15.940860045120456, 10.145004942546468, 0, 16.45302972163988, 16.414840222244035, 14.03981641123922, 16.315089704442286, 9.012523470101351, 3.4267158583125052, 15.967717108619102, 12.086337728501917, 17.605368063792138, 16.42582257192317, 10.000531612181685, 17.6120412972415, 11.506936320640536, 5.654547438086134, 11.106118766330859, 16.181245377294253, 4.762535699213395, 18.183177959627816, 11.861512413085922, 12.528613899541623, 15.472514035794061, 15.865041290149113, 3.971819294142056, 15.797679415558589, 6.218863015821057, 7.388476121559724, 13.121843511776104, 5.500011707432099, 16.36907606888642, 8.260728618166874, 5.161292210939989, 0, 16.006889696498778, 16.65122404583137, 16.885983667194978, 0, 15.607529265594764, 15.7706373506499, 16.21987667052404, 18.17301853309868, 4.673159072787667, 16.669892268081608]
	main(120,75,Battery_INIT)
	Battery_INIT = [16.06608788980173, 16.40594773316898, 10.21285315684586, 9.158535798656063, 17.419514412176703, 5.380433071612697, 14.702698329273154, 16.22948140161058, 0, 14.744396225977658, 16.59833272692263, 15.676835851182316, 10.316446467927696, 15.63132083933254, 14.874737944239103, 16.822715848702753, 14.010979540283579, 12.421921294190424, 17.168466104881215, 17.410378450141753, 2.6220083815064212, 5.710237564629689, 0, 17.92121586994441, 14.320127335132982, 17.171571544684394, 4.348653272855337, 8.894743546468435, 16.123388873553065, 0, 17.410995006932378, 8.427716932317978, 0, 17.411373682223413, 0.23813250453566415, 12.661925780280203, 16.55068273431446, 8.624845278177826, 17.355306040430225, 15.266204700422927, 15.888184940161887, 4.426651104915601, 4.156570087496608, 10.82204898979229, 14.035652607304687, 15.69493795679184, 9.19191831414601, 0, 16.204778708770196, 16.16693578781607, 13.23457881611964, 16.07095553579252, 8.147950096680322, 3.0759732681762078, 14.886625050076935, 11.016200762486084, 17.351632898166265, 16.180189095232112, 9.073752184015264, 17.358257439500598, 10.51597177057332, 4.934172217211033, 9.70946686176623, 15.934364292825311, 4.021885419866082, 17.92498945689083, 11.095514947255886, 11.402265688298295, 14.075615572884074, 15.621377004167853, 3.818349586018755, 15.022844156073303, 5.619093686528287, 6.755061224117906, 12.047642568334755, 4.8012339313714705, 14.624846778243882, 7.273778860308411, 4.311579831014405, 0, 14.305816434464706, 16.355616612116638, 16.63446658931731, 0, 13.541936982186433, 13.821626092711758, 15.97644059758403, 17.914972324110554, 3.9766941745001243, 16.381295297552967, 16.512682424159426, 5.105879565057674, 17.91470214401497, 10.71200795881498, 15.704749034526824, 9.355841722827735, 8.217542378632029, 10.702779114497575, 0.4153371673396254, 12.608858459095295, 0.9053089189754789, 0, 16.591729485333538, 11.749116146063521, 13.109118708191424, 16.19279689426003, 16.214852668072442, 4.883733850711015, 16.778946768240694, 4.7798839951545204, 7.023573377084252, 8.046814689350468, 9.327456983612214, 15.890749521990033, 6.231166446722287, 15.836259758222235, 14.947071020295297, 15.591507871028426, 15.597246895180554, 16.88973418812066] 
	main(160,75,Battery_INIT)
	Battery_INIT = [16.08674888100174, 16.426879307997076, 10.591787689757744, 9.347407679760433, 17.441642726128357, 5.703539484435993, 15.41061774945296, 16.25024434128976, 0, 14.785450083965278, 16.619338516622122, 15.697218246850039, 10.696040821557581, 15.651689536361214, 15.179436042719445, 16.844254795672374, 14.613578232701705, 12.704176422459737, 17.19024364991727, 17.432488687829917, 2.755854091434735, 5.928703825257555, 0, 17.943870415528473, 14.739323257765781, 17.19335050395931, 4.638358417896779, 8.961017887842301, 16.14399705949297, 0, 17.433095839603407, 8.441149149762069, 0, 17.43349380240288, 0.36126631612500987, 12.678794953115451, 16.571766510400337, 8.638482579056591, 17.37735026844206, 15.530279415941628, 15.908613341833453, 4.555353511101074, 4.295460720451478, 11.224834892719366, 14.832050284651238, 15.715465381889345, 9.558463914710359, 0, 16.225453536768736, 16.187635193998133, 13.52984246345393, 16.09159589855926, 8.479717364390714, 3.211860099993693, 15.451229638367549, 11.42687991864615, 17.37367808302361, 16.200903379410853, 9.429871623680294, 17.38030667887086, 10.894258320895306, 5.216670955757621, 10.25821340588403, 15.954851752473937, 4.315068650072059, 17.947647014390203, 11.369106408680876, 11.83462441725272, 14.850909900381529, 15.641737279545193, 3.8747540924213806, 15.46192278551327, 5.844151362334046, 6.991865100222417, 12.45306781020752, 5.073607782320837, 15.290200608089474, 7.660859275207343, 4.641466843255737, 0, 14.920073780855725, 16.398864820597364, 16.655535794050852, 0, 14.335051146781941, 14.515050798313874, 15.997001848662556, 17.93761720678309, 4.250503477032615, 16.424700636867914, 16.533846460603, 5.420429761948262, 17.937348928786346, 11.116382700457617, 15.725296488966102, 9.428267735502445, 8.624836170579131, 11.108386646630613, 0.5525806276717554, 12.856832627714375, 1.041004202553007, 0, 16.612841269087795, 12.164758178911605, 13.381879300766863, 16.21368934899783, 16.25772194215391, 5.113070085058545, 16.800425299970787, 5.094138954248642, 7.388382326199515, 8.561854420780206, 9.71646551875143, 15.911185002796508, 6.45359385030292, 15.856787057905551, 15.615210511769654, 15.61182340192103, 15.617575137722833, 16.911329552354392, 16.068595187829906, 16.710884806049812, 12.84849033765014, 16.008071200371504, 16.5191364938064, 6.712712131611569, 16.860227437602948, 15.257196814491415, 16.335556619872605, 11.594066856609093, 17.171406834325076, 15.216581088823446, 7.866394345801683, 5.280011816248761, 16.644824992576687, 4.2988868195742445, 17.354643156696998, 10.706029925463481, 4.785466704574605, 15.895454132211466, 14.870104010996558, 3.753907447980224, 4.73129435912739, 3.740194885732032, 16.165882615574738, 5.08048151254696, 17.94395872103661, 15.977650928106428, 16.19364311616032, 9.626298493056373]
	main(200,75,Battery_INIT)

	
	print("Finished!")
	#main(100,50)




	



